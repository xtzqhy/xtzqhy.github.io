<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>值域分块学习笔记 | xtzqhy's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="/js/gitalk.js"></script><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script async src="/js/gitalk.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
  menuSettings: {
    zoom: "None"
  },
  showMathMenu: false,
  jax: ["input/TeX","output/CommonHTML"],
  extensions: ["tex2jax.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js"],
    equationNumbers: {
      autoNumber: "AMS"
    }
  },
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]]
  }
});
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {gitalk = new Gitalk({
 clientID: 'Ov23lidIwUC42TZcbOGp',
 clientSecret: 'd3e1bc6e3c657d63c896defaee92f69829d836c7',
 repo: 'https://xtzqhy.github.io/',
 owner: 'xtzqhy',
 admin: ['xtzqhy'],
 distractionFreeMode: false,
 id: 
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {gitalk = new Gitalk({
 clientID: 'Ov23lidIwUC42TZcbOGp',
 clientSecret: 'd3e1bc6e3c657d63c896defaee92f69829d836c7',
 repo: 'https://xtzqhy.github.io/',
 owner: 'xtzqhy',
 admin: ['xtzqhy'],
 distractionFreeMode: false,
 id: 
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>值域分块学习笔记</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-10-05T08:39:01.000Z" id="date"> 2024-10-05</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-10-10T08:54:42.731Z" id="updated"> 2024-10-10</time></div></span><br><span>文章总字数: <div class="control">9.4k</div></span><br><span>预计阅读时间: <div class="control">49 分钟</div></span></div></div><hr><div id="post-content"><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Athanasy/p/18033341">参考文章</a></p>
<p>又是一个很有用但一直不会的东西，今天学习一下。</p>
<p>不过写的还是比较浅显，可以看参考文章，讲的很好。</p>
<h3 id="什么是值域分块"><a href="#什么是值域分块" class="headerlink" title="什么是值域分块"></a>什么是值域分块</h3><p>普通的分块都学过，它是对序列分块的。</p>
<p>而值域分块，顾名思义，是对值域分块。</p>
<p>序列分块和值域分块的关系就像线段树和权值线段树的关系一样，一个维护序列，一个维护值域。</p>
<h3 id="两种常用的值域分块"><a href="#两种常用的值域分块" class="headerlink" title="两种常用的值域分块"></a>两种常用的值域分块</h3><p>第一种：修改 <script type="math/tex">O(1)</script>，查询 <script type="math/tex">O(\sqrt n)</script></p>
<p>维护每个值域上每个值的值和每个值域块内的值的总和。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;++cnt1[x],++cnt2[bel[x]];&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query1</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r],res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) res+=cnt1[i];<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) res+=cnt1[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) res+=cnt1[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L<span class="hljs-number">+1</span>;i&lt;=R<span class="hljs-number">-1</span>;++i) res+=cnt2[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>第二种：修改 <script type="math/tex">O(\sqrt n)</script>，查询 <script type="math/tex">O(1)</script></p>
<p>维护每个值域上每个值的值的前缀和，修改时整块打标记，散块暴力加。</p>
<p>区间查询可以差分成两个前缀和。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(tag1[bel[x]])&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[bel[x]];i&lt;=ed[bel[x]];++i) cnt[i]+=tag1[bel[x]];<br>        tag1[bel[x]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(tag2[bel[x]])&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[bel[x]];i&lt;=ed[bel[x]];++i) sum[i]+=tag2[bel[x]];<br>        tag2[bel[x]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=x;i&lt;=ed[bel[x]];++i) ++cnt[i],sum[i]+=x;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=bel[x]<span class="hljs-number">+1</span>;i&lt;=tot;++i) ++tag1[i],tag2[i]+=x;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query1</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">return</span> tag1[bel[x]]+cnt[x];&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">return</span> tag2[bel[x]]+sum[x];&#125;<br></code></pre></td></tr></table></figure>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>值域分块一般用来平衡复杂度。</p>
<p>例如莫队，我们有 <script type="math/tex">O(n\sqrt n)</script> 次修改和  <script type="math/tex">O(n)</script> 次查询，这时可以用 <script type="math/tex">O(1)</script> 修改，<script type="math/tex">O(\sqrt n)</script> 查询的值域分块平衡复杂度。</p>
<p>而如果用 <script type="math/tex">O(\log n)</script> 修改，<script type="math/tex">O(\log n)</script> 查询的其他数据结构，复杂度就来到了混乱邪恶的 <script type="math/tex">O(n\sqrt n \log n)</script>，不可接受。</p>
<h3 id="值域分块配合莫队"><a href="#值域分块配合莫队" class="headerlink" title="值域分块配合莫队"></a>值域分块配合莫队</h3><p>例题1：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4396">[AHOI2013] 作业</a></p>
<p>可以说是板子题了。</p>
<p>使用 <script type="math/tex">O(1)</script> 修改，<script type="math/tex">O(\sqrt n)</script> 查询的值域分块。</p>
<p>复杂度 <script type="math/tex">O(n\sqrt n)</script>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">1e5</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">500</span>;<br><span class="hljs-type">int</span> n,m,siz,tot;<br><span class="hljs-type">int</span> a[maxn];<br><span class="hljs-type">int</span> ans1[maxn],ans2[maxn];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn];<br><span class="hljs-type">int</span> cnt1[maxm],cnt2[maxn],cnt3[maxm];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">query</span>&#123;<br>    <span class="hljs-type">int</span> l,r,a,b,id;<br>&#125;q[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(query a,query b)</span></span>&#123;<span class="hljs-keyword">return</span> ((a.l/siz)^(b.l/siz))?(a.l/siz)&lt;(b.l/siz):((a.l/siz)&amp;<span class="hljs-number">1</span>)?a.r&lt;b.r:a.r&gt;b.r;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    siz=<span class="hljs-built_in">sqrt</span>(n);<br>    tot=n/siz;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;n) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=n;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(!cnt2[x]) ++cnt3[bel[x]];<br>    ++cnt1[bel[x]];<br>    ++cnt2[x];<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">del</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<br>    --cnt1[bel[x]];<br>    --cnt2[x];<br>    <span class="hljs-keyword">if</span>(!cnt2[x]) --cnt3[bel[x]];<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">get_ans1</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r];<br>    <span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) res+=cnt2[i];<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) res+=cnt2[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) res+=cnt2[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L<span class="hljs-number">+1</span>;i&lt;=R<span class="hljs-number">-1</span>;++i) res+=cnt1[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">get_ans2</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r];<br>    <span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) res+=(<span class="hljs-type">bool</span>)cnt2[i];<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) res+=(<span class="hljs-type">bool</span>)cnt2[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) res+=(<span class="hljs-type">bool</span>)cnt2[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L<span class="hljs-number">+1</span>;i&lt;=R<span class="hljs-number">-1</span>;++i) res+=cnt3[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span>	</span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) cin&gt;&gt;q[i].l&gt;&gt;q[i].r&gt;&gt;q[i].a&gt;&gt;q[i].b,q[i].id=i;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-built_in">sort</span>(q<span class="hljs-number">+1</span>,q+m<span class="hljs-number">+1</span>,cmp);<br>    <span class="hljs-type">int</span> l=<span class="hljs-number">1</span>,r=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i)&#123;<br>        <span class="hljs-keyword">while</span>(r&lt;q[i].r) <span class="hljs-built_in">add</span>(a[++r]);<br>        <span class="hljs-keyword">while</span>(l&gt;q[i].l) <span class="hljs-built_in">add</span>(a[--l]);<br>        <span class="hljs-keyword">while</span>(r&gt;q[i].r) <span class="hljs-built_in">del</span>(a[r--]);<br>        <span class="hljs-keyword">while</span>(l&lt;q[i].l) <span class="hljs-built_in">del</span>(a[l++]);<br>        ans1[q[i].id]=<span class="hljs-built_in">get_ans1</span>(q[i].a,q[i].b);<br>        ans2[q[i].id]=<span class="hljs-built_in">get_ans2</span>(q[i].a,q[i].b);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) cout&lt;&lt;ans1[i]&lt;&lt;<span class="hljs-string">&quot; &quot;</span>&lt;&lt;ans2[i]&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>例题2：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P5047">[Ynoi2019 模拟赛] Yuno loves sqrt technology II</a> </p>
<p>区间逆序对，不难想到用树状数组维护修改。</p>
<p>但这样复杂度是 <script type="math/tex">O(n\sqrt n \log n)</script> 的，不能接受。</p>
<p>但可以发现，这个贡献是可以差分的，所以考虑莫队二次离线。</p>
<p>这里还是把二离详细说一下吧（毕竟我也不太懂）。</p>
<p>假设当前在区间 <script type="math/tex">[l,r]</script>。</p>
<p>我们分四种情况讨论指针的移动。</p>
<p>1.右指针右移</p>
<p>考虑当前到的位置 <script type="math/tex">r+1</script>，此时会产生的新贡献是 <script type="math/tex">[l,r]</script> 里大于 <script type="math/tex">a_{r+1}</script> 的个数。</p>
<p>可以差分成 <script type="math/tex">[1,r]</script> 中大于 <script type="math/tex">a_{r+1}</script> 的个数减去 <script type="math/tex">[1,l-1]</script> 大于 <script type="math/tex">a_{r+1}</script> 的个数。</p>
<p>2.右指针左移</p>
<p>考虑当前到的位置 <script type="math/tex">r-1</script>，此时会<strong>减少</strong>的贡献是 <script type="math/tex">[l,r-1]</script> 里大于 <script type="math/tex">a_r</script> 的个数。</p>
<p>可以差分成 <script type="math/tex">[1,r-1]</script> 中大于 <script type="math/tex">a_r</script> 的个数减去 <script type="math/tex">[1,l-1]</script> 大于 <script type="math/tex">a_r</script> 的个数。</p>
<p>3.左指针左移</p>
<p>考虑当前到的位置 <script type="math/tex">l-1</script>，此时会产生的新贡献是 <script type="math/tex">[l,r]</script> 里小于 <script type="math/tex">a_{l-1}</script> 的个数。</p>
<p>可以差分成 <script type="math/tex">[1,r]</script> 中小于 <script type="math/tex">a_{l-1}</script> 的个数减去 <script type="math/tex">[1,l-1]</script> 小于 <script type="math/tex">a_{l-1}</script> 的个数。</p>
<p>4.左指针右移</p>
<p>考虑当前到的位置 <script type="math/tex">l+1</script>，此时会<strong>减少</strong>的贡献是 <script type="math/tex">[l+1,r]</script> 里小于 <script type="math/tex">a_l</script> 的个数。</p>
<p>可以差分成 <script type="math/tex">[1,r]</script> 中小于 <script type="math/tex">a_l</script> 的个数减去 <script type="math/tex">[1,l]</script> 小于 <script type="math/tex">a_l</script> 的个数。</p>
<p>请注意上文的减少，因为是减少下面的那个东西，所以要记得变号。</p>
<p>然后可以发现有一些可以预处理出来。</p>
<p>例如 <script type="math/tex">[1,i-1]</script> 中 <script type="math/tex">> a_i</script> 的个数，<script type="math/tex">[1,i]</script> 中 <script type="math/tex">< a_i</script> 的个数。</p>
<p>然后剩下的部分离线下来，一共 <script type="math/tex">O(n\sqrt n)</script> 次修改和 <script type="math/tex">O(n)</script> 次询问。</p>
<p>然后扫描线，用数据结构维护剩下形如：每次求一个前缀中 <script type="math/tex">> x</script> 或 <script type="math/tex">< x</script> 的数的个数。</p>
<p>这让你想到了什么？值域分块！</p>
<p>我们用 <script type="math/tex">O(1)</script> 修改，<script type="math/tex">O(\sqrt n)</script> 查询的值域分块维护这个东西。</p>
<p>最后，别忘了我们上面讨论的都是变化量，相当于答案的差分，所以最后还要求个前缀和得到答案。</p>
<p>然后大概就做完了，吗？</p>
<p>Ynoi，怎么能不卡常呢？</p>
<p>首先是卡空间。</p>
<p>我们如果直接存 <script type="math/tex">O(n\sqrt n)</script> 次修改，空间复杂度是 <script type="math/tex">O(n\sqrt n)</script> 的。</p>
<p>但是不难发现，莫队每次的指针移动是一段区间，所以直接把这一段区间一块存下来就行了。</p>
<p>空间复杂度变为 <script type="math/tex">O(n)</script>。</p>
<p>然后是卡时间。</p>
<p>预处理的那部分最好直接处理前缀和（然而代码里没这么写）。</p>
<p>少开 long long。</p>
<p>值域分块最好这么分：</p>
<p>维护值域上每个数的出现次数的前缀和，然后单点修改打标记。这样常数很小。</p>
<p>而不是这么分：</p>
<p>维护值域块的前缀和以及每个值域块内的前缀和，单点修改直接改前缀和即可。常数较大。</p>
<p>代码里是第二种，因为第一种写挂了。</p>
<p>改成第一种就能过了。</p>
<p>下面是一份可以在 300ms 左右通过所有数据的代码。</p>
<p>不想卡常了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-comment">// #define int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> lb(x) (x&amp;(-x))</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">1e5</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">500</span>;<br><span class="hljs-type">int</span> n,m,siz,tot,len;<br><span class="hljs-type">int</span> a[maxn],b[maxn],tr[maxn];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn],idx[maxn];<br><span class="hljs-type">int</span> fl[maxn],fr[maxn];<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> ans[maxn],cnt1[maxm],cnt2[maxm][maxm];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">query</span>&#123;<br>    <span class="hljs-type">int</span> l,r,id;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> ans;<br>&#125;q[maxn];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span>&#123;<br>    <span class="hljs-type">int</span> l,r,id,op;<br>&#125;;<br>vector&lt;node&gt; g1[maxn],g2[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(query a,query b)</span></span>&#123;<span class="hljs-keyword">return</span> ((a.l/siz)^(b.l/siz))?(a.l/siz)&lt;(b.l/siz):((a.l/siz)&amp;<span class="hljs-number">1</span>)?a.r&lt;b.r:a.r&gt;b.r;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span>&#123;<span class="hljs-keyword">while</span>(x&lt;=maxn) tr[x]+=val,x+=<span class="hljs-built_in">lb</span>(x);&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<span class="hljs-keyword">while</span>(x&gt;<span class="hljs-number">0</span>) res+=tr[x],x-=<span class="hljs-built_in">lb</span>(x);<span class="hljs-keyword">return</span> res;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pre</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i)&#123;<br>        fr[i]=i<span class="hljs-number">-1</span>-<span class="hljs-built_in">query</span>(a[i]);<br>        <span class="hljs-built_in">add</span>(a[i],<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) <span class="hljs-built_in">add</span>(a[i],<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i)&#123;<br>        <span class="hljs-built_in">add</span>(a[i],<span class="hljs-number">1</span>);<br>        fl[i]=<span class="hljs-built_in">query</span>(a[i]<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    siz=<span class="hljs-built_in">sqrt</span>(len);<br>    tot=<span class="hljs-built_in">ceil</span>(len/siz);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;len) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=len;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i,idx[j]=j-st[i]<span class="hljs-number">+1</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span>&#123;<br>    <span class="hljs-type">int</span> id=bel[x];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=id;i&lt;=tot;++i) cnt1[i]+=val;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=idx[x];i&lt;=idx[ed[id]];++i) cnt2[id][i]+=val;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r];<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) res+=(cnt2[L][idx[r]]-cnt2[L][idx[l]<span class="hljs-number">-1</span>]);<br>    <span class="hljs-keyword">else</span>&#123;<br>        res+=(cnt2[L][idx[ed[L]]]-cnt2[L][idx[l]<span class="hljs-number">-1</span>]);<br>        res+=(cnt2[R][idx[r]]);<br>        res+=(cnt1[R<span class="hljs-number">-1</span>]-cnt1[L]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve_l</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i)&#123;<br>        <span class="hljs-built_in">update</span>(a[i],<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> t:g1[i])&#123;<br>            <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=t.l;j&lt;=t.r;++j)&#123;<br>                q[t.id].ans+=t.op*(i-<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,a[j]));<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) <span class="hljs-built_in">update</span>(a[i],<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve_r</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i)&#123;<br>        <span class="hljs-built_in">update</span>(a[i],<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> t:g2[i])&#123;<br>            <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=t.l;j&lt;=t.r;++j)&#123;<br>                q[t.id].ans+=t.op*<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,a[j]<span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i],b[i]=a[i];<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>);<br>    len=<span class="hljs-built_in">unique</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>)-(b<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) a[i]=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+len<span class="hljs-number">+1</span>,a[i])-b;<br>    <span class="hljs-built_in">pre</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) cin&gt;&gt;q[i].l&gt;&gt;q[i].r,q[i].id=i;<br>    siz=<span class="hljs-built_in">sqrt</span>(n);<br>    <span class="hljs-built_in">sort</span>(q<span class="hljs-number">+1</span>,q+m<span class="hljs-number">+1</span>,cmp);<br>    <span class="hljs-type">int</span> l=<span class="hljs-number">1</span>,r=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i)&#123;<br>        <span class="hljs-keyword">if</span>(r&lt;q[i].r)&#123;<br>            g1[l<span class="hljs-number">-1</span>].<span class="hljs-built_in">push_back</span>(&#123;r<span class="hljs-number">+1</span>,q[i].r,i,<span class="hljs-number">-1</span>&#125;);<br>            <span class="hljs-keyword">while</span>(r&lt;q[i].r) q[i].ans+=fr[++r];<br>        &#125;<br>        <span class="hljs-keyword">if</span>(l&gt;q[i].l)&#123;<br>            g2[r].<span class="hljs-built_in">push_back</span>(&#123;q[i].l,l<span class="hljs-number">-1</span>,i,<span class="hljs-number">1</span>&#125;);<br>            <span class="hljs-keyword">while</span>(l&gt;q[i].l) q[i].ans-=fl[--l];<br>        &#125;<br>        <span class="hljs-keyword">if</span>(r&gt;q[i].r)&#123;<br>            g1[l<span class="hljs-number">-1</span>].<span class="hljs-built_in">push_back</span>(&#123;q[i].r<span class="hljs-number">+1</span>,r,i,<span class="hljs-number">1</span>&#125;);<br>            <span class="hljs-keyword">while</span>(r&gt;q[i].r) q[i].ans-=fr[r--];<br>        &#125;<br>        <span class="hljs-keyword">if</span>(l&lt;q[i].l)&#123;<br>            g2[r].<span class="hljs-built_in">push_back</span>(&#123;l,q[i].l<span class="hljs-number">-1</span>,i,<span class="hljs-number">-1</span>&#125;);<br>            <span class="hljs-keyword">while</span>(l&lt;q[i].l) q[i].ans+=fl[l++];<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-built_in">solve_l</span>();<br>    <span class="hljs-built_in">solve_r</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) q[i].ans+=q[i<span class="hljs-number">-1</span>].ans;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) ans[q[i].id]=q[i].ans;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) cout&lt;&lt;ans[i]&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="值域分块配合根号分治"><a href="#值域分块配合根号分治" class="headerlink" title="值域分块配合根号分治"></a>值域分块配合根号分治</h3><p>例题：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P8146">[JRKSJ R4] risrqnis</a></p>
<p>很好的一道题，加深了我对根号分治和平衡复杂度的理解。</p>
<p>首先考虑 <script type="math/tex">m=1</script> 怎么做。</p>
<p>这个对值域上的操作很讨厌，因为值域很大。</p>
<p>但不难发现，把所有操作离线后离散化，可以做到值域 <script type="math/tex">O(n)</script>，且每个数至多被加入一次。</p>
<p>所以我们把每个数挂到对应的值上，然后用 set 维护还没有被加入的数，每次加入时查值域上的前驱后继即可。至于求和，树状数组维护即可。</p>
<p>这样做的话，均摊复杂度是 <script type="math/tex">O(n\log n)</script> 的。</p>
<p>那 <script type="math/tex">m \le 10^9</script> 怎么办？</p>
<p>首先可以把 <script type="math/tex">m</script> 离散化到 <script type="math/tex">O(n)</script>。</p>
<p>然后关键来了：考虑对每个集合的操作次数根号分治。</p>
<p>对于操作次数 <script type="math/tex">> \sqrt n</script> 的集合，个数是 <script type="math/tex">O(\sqrt n)</script> 的，那么我们直接按上面那个做法做，总复杂度是 <script type="math/tex">O(n\sqrt n \log n)</script> 的。</p>
<p>但这个复杂度是不能接受的。</p>
<p>但可以发现，我们一共有 <script type="math/tex">O(n\sqrt n)</script> 次修改和 <script type="math/tex">O(n)</script> 次查询（这里可能会有疑惑：每个集合的修改和询问不都是 <script type="math/tex">O(n)</script> 的吗？那总的操作为什么不都是 <script type="math/tex">O(n\sqrt n)</script>？因为总的操作次数一共是 <script type="math/tex">O(n)</script> 的，而修改是值域上的修改，所以可以保证每个集合都做到 <script type="math/tex">O(n)</script> 次修改，但查询是有总和保证的，总询问一定也是 <script type="math/tex">O(n)</script> 的）。</p>
<p>所以可以用序列分块来平衡复杂度，这样可以做到 <script type="math/tex">O(1)</script> 修改，<script type="math/tex">O(\sqrt n)</script> 查询。</p>
<p>然后瓶颈就是 set 每次查找的 <script type="math/tex">O(\log n)</script> 了，我们考虑去掉这个 <script type="math/tex">\log</script> 。</p>
<p>一开始想到的是链表，但链表删除虽然是 <script type="math/tex">O(1)</script>，但每次还得找第一个没被删的，这是 <script type="math/tex">O(n)</script> 的。</p>
<p>然后想到并查集，发现可以做。</p>
<p>思路还是和链表一样，每删一个就更新父亲，相当于把那个数删除了。</p>
<p>每次找的时候也是找父亲。</p>
<p>总复杂度为 <script type="math/tex">O(n\sqrt n \alpha(n))</script></p>
<p>然后考虑操作次数 <script type="math/tex">< \sqrt n</script> 的集合。</p>
<p>这种集合的个数是 <script type="math/tex">O(n)</script> 的，但操作次数是 <script type="math/tex">O(\sqrt n)</script> 的。</p>
<p>这可以得到一个很关键的性质：操作后的值域上的连续段个数不超过 <script type="math/tex">O(\sqrt n)</script>。</p>
<p>然后我们再想想询问在干什么：求值域上在已经出现过的连续段内且序列上下标在 <script type="math/tex">[l,r]</script> 之间的点的个数。</p>
<p>这是个标准的二维数点。</p>
<p>因为连续段个数不超过 <script type="math/tex">O(\sqrt n)</script>，所以询问可以看成对 <script type="math/tex">O(\sqrt n)</script> 个连续段分别查询。</p>
<p>那么一共有 <script type="math/tex">O(n)</script> 次修改和 <script type="math/tex">O(n\sqrt n)</script> 次询问（这里可能又有疑惑：一共 <script type="math/tex">O(n)</script> 个集合，每个集合修改次数都是 <script type="math/tex">O(n)</script> 的，那为什么总修改次数还是 <script type="math/tex">O(n)</script> 的？因为可以发现，具体是哪个集合对答案没有影响，所以我们可以先把所有询问离线下来，这样一共有 <script type="math/tex">O(n\sqrt n)</script> 次询问，但我们只需要修改 <script type="math/tex">O(n)</script> 次即可）。</p>
<p>考虑扫描序列维，然后用值域分块维护另一维。</p>
<p>总复杂度 <script type="math/tex">O(n\sqrt n)</script></p>
<p>综上，总复杂度为 <script type="math/tex">O(n\sqrt n \alpha(n))</script>。</p>
<p>但你先别急，因为这东西空间复杂度是 <script type="math/tex">O(n\sqrt n)</script>，直接炸了。</p>
<p>然后有一些神奇技巧来优化空间，例如离线逐块处理，分散层叠等。</p>
<p>但我摆了。</p>
<p>还有个坑点，在处理小块的时候，我们要离线询问，但是不能直接离线。</p>
<p>例如第一次修改，把值域 <script type="math/tex">[l_1,r_1]</script> 加进去，第二次修改，把值域 <script type="math/tex">[l_2,r_2]</script> 加进去。</p>
<p>如果这两段有交，那么交集部分不能算两次，只能算一次。</p>
<p>所以离线询问时要处理这个东西。</p>
<p>注意特殊处理 <script type="math/tex">m=1</script> ，因为空间开不下。</p>
<p>还有注意离散化后值域是 <script type="math/tex">3\times 10^6</script></p>
<p>代码是空间 <script type="math/tex">O(n\sqrt n)</script> 的，只能得 45 pts。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-comment">// #define int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pii pair<span class="hljs-string">&lt;int,int&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fi first</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> se second</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> lb(x) (x&amp;(-x))</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">1e6</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">1750</span>;<br><span class="hljs-type">int</span> n,m,Q,siz,tot,cnt;<br><span class="hljs-type">int</span> a[maxn],b[<span class="hljs-number">3</span>*maxn],ans[maxn],fa[maxn*<span class="hljs-number">3</span>];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn],idx[maxn];<br><span class="hljs-type">int</span> sum1[maxn],sum2[maxm];<br>pii stk[maxn];<br><span class="hljs-type">int</span> cnt1[maxn*<span class="hljs-number">3</span>],cnt2[maxm][maxm];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">query</span>&#123;<br>    <span class="hljs-type">int</span> op,l,r,k,id;<br>&#125;q[maxn];<br>vector&lt;<span class="hljs-type">int</span>&gt; g[maxn],s[maxn];<br>vector&lt;query&gt; q1[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> tmp=<span class="hljs-built_in">max</span>(n,cnt);<br>    siz=<span class="hljs-built_in">sqrt</span>(tmp);<br>    tot=<span class="hljs-built_in">ceil</span>(tmp/siz);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;tmp) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=tmp;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i,idx[j]=j-st[i]<span class="hljs-number">+1</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=cnt<span class="hljs-number">+1</span>;++i) fa[i]=i;<br>    <span class="hljs-built_in">memset</span>(sum1,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span> sum1),<span class="hljs-built_in">memset</span>(sum2,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span> sum2);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;++sum1[x],++sum2[bel[x]];&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r],res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) res+=sum1[i];<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) res+=sum1[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) res+=sum1[i];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L<span class="hljs-number">+1</span>;i&lt;=R<span class="hljs-number">-1</span>;++i) res+=sum2[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">if</span>(x!=fa[x]) fa[x]=<span class="hljs-built_in">find</span>(fa[x]);<span class="hljs-keyword">return</span> fa[x];&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve1</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>    <span class="hljs-built_in">clear</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> x:g[id])&#123;<br>        <span class="hljs-keyword">if</span>(q[x].op==<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-type">int</span> pos=<span class="hljs-built_in">find</span>(q[x].l);<br>            <span class="hljs-keyword">while</span>(pos&lt;=q[x].r)&#123;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> v:s[pos]) <span class="hljs-built_in">add</span>(v);<br>                fa[pos]=fa[pos<span class="hljs-number">+1</span>];<br>                pos=<span class="hljs-built_in">find</span>(pos<span class="hljs-number">+1</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> ans[q[x].id]=<span class="hljs-built_in">query</span>(q[x].l,q[x].r);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve2</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>    <span class="hljs-type">int</span> top=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> x:g[id])&#123;<br>        <span class="hljs-keyword">if</span>(q[x].op==<span class="hljs-number">1</span>) stk[++top]=&#123;q[x].l,q[x].r&#125;;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">if</span>(!top) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-built_in">sort</span>(stk<span class="hljs-number">+1</span>,stk+top<span class="hljs-number">+1</span>);<br>            <span class="hljs-type">int</span> nowl=stk[<span class="hljs-number">1</span>].fi,nowr=stk[<span class="hljs-number">1</span>].se;<br>            <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=top;++i)&#123;<br>                <span class="hljs-keyword">if</span>(stk[i].fi&lt;=nowr) nowr=<span class="hljs-built_in">max</span>(nowr,stk[i].se);<br>                <span class="hljs-keyword">else</span>&#123;<br>                    q1[q[x].l<span class="hljs-number">-1</span>].<span class="hljs-built_in">push_back</span>(&#123;<span class="hljs-number">-1</span>,nowl,nowr,<span class="hljs-number">998244353</span>,q[x].id&#125;);<br>                    q1[q[x].r].<span class="hljs-built_in">push_back</span>(&#123;<span class="hljs-number">1</span>,nowl,nowr,<span class="hljs-number">998244353</span>,q[x].id&#125;);	<br>                    nowl=stk[i].fi,nowr=stk[i].se;<br>                &#125;<br>            &#125;<br>            q1[q[x].l<span class="hljs-number">-1</span>].<span class="hljs-built_in">push_back</span>(&#123;<span class="hljs-number">-1</span>,nowl,nowr,<span class="hljs-number">998244353</span>,q[x].id&#125;);<br>            q1[q[x].r].<span class="hljs-built_in">push_back</span>(&#123;<span class="hljs-number">1</span>,nowl,nowr,<span class="hljs-number">998244353</span>,q[x].id&#125;);	<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<br>    <span class="hljs-type">int</span> id=bel[x];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=id;i&lt;=tot;++i) ++cnt1[i];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=idx[x];i&lt;=idx[ed[id]];++i) ++cnt2[id][i];<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query1</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r];<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> res=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R) res+=(cnt2[L][idx[r]]-cnt2[L][idx[l]<span class="hljs-number">-1</span>]);<br>    <span class="hljs-keyword">else</span>&#123;<br>        res+=(cnt2[L][idx[ed[L]]]-cnt2[L][idx[l]<span class="hljs-number">-1</span>]);<br>        res+=(cnt2[R][idx[r]]);<br>        res+=(cnt1[R<span class="hljs-number">-1</span>]-cnt1[L]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i)&#123;<br>        <span class="hljs-built_in">update</span>(a[i]);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> x:q1[i])&#123;<br>            ans[x.id]+=x.op*<span class="hljs-built_in">query1</span>(x.l,x.r);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> tr[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span>&#123;<span class="hljs-keyword">while</span>(x&lt;=n) tr[x]+=val,x+=<span class="hljs-built_in">lb</span>(x);&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<span class="hljs-keyword">while</span>(x) res+=tr[x],x-=<span class="hljs-built_in">lb</span>(x);<span class="hljs-keyword">return</span> res;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">solve0</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i],b[i]=a[i],stk[i]=&#123;a[i],i&#125;;<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>);<span class="hljs-built_in">sort</span>(stk<span class="hljs-number">+1</span>,stk+n<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n<span class="hljs-number">+1</span>;++i) fa[i]=i;<br>    <span class="hljs-type">int</span> op,l,r,k;<br>    <span class="hljs-keyword">while</span>(Q--)&#123;<br>        cin&gt;&gt;op&gt;&gt;l&gt;&gt;r&gt;&gt;k;<br>        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>)&#123;<br>            l=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>,l)-b,r=<span class="hljs-built_in">upper_bound</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>,r)-b<span class="hljs-number">-1</span>;<br>            <span class="hljs-type">int</span> pos=<span class="hljs-built_in">find</span>(l);<br>            <span class="hljs-keyword">while</span>(pos&lt;=r)&#123;<br>                <span class="hljs-built_in">add</span>(stk[pos].se,<span class="hljs-number">1</span>);<br>                fa[pos]=fa[pos<span class="hljs-number">+1</span>];<br>                pos=<span class="hljs-built_in">find</span>(pos<span class="hljs-number">+1</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> cout&lt;&lt;<span class="hljs-built_in">query</span>(r)-<span class="hljs-built_in">query</span>(l<span class="hljs-number">-1</span>)&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;Q&gt;&gt;m;<br>    <span class="hljs-keyword">if</span>(m==<span class="hljs-number">1</span>)&#123;<span class="hljs-built_in">solve0</span>();<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=Q;++i) cin&gt;&gt;q[i].op&gt;&gt;q[i].l&gt;&gt;q[i].r&gt;&gt;q[i].k,q[i].id=i,b[i]=q[i].k;<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+Q<span class="hljs-number">+1</span>);<br>    m=<span class="hljs-built_in">unique</span>(b<span class="hljs-number">+1</span>,b+Q<span class="hljs-number">+1</span>)-(b<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=Q;++i) q[i].k=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+m<span class="hljs-number">+1</span>,q[i].k)-b,g[q[i].k].<span class="hljs-built_in">push_back</span>(i);<br>    cnt=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) b[++cnt]=a[i];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=Q;++i) <span class="hljs-keyword">if</span>(q[i].op==<span class="hljs-number">1</span>) b[++cnt]=q[i].l,b[++cnt]=q[i].r;<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>);<br>    cnt=<span class="hljs-built_in">unique</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>)-(b<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) a[i]=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>,a[i])-b,s[a[i]].<span class="hljs-built_in">push_back</span>(i);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=Q;++i) <span class="hljs-keyword">if</span>(q[i].op==<span class="hljs-number">1</span>) q[i].l=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>,q[i].l)-b,q[i].r=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>,q[i].r)-b;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i)&#123;<br>        <span class="hljs-keyword">if</span>(g[i].<span class="hljs-built_in">size</span>()&gt;=<span class="hljs-built_in">sqrt</span>(Q)) <span class="hljs-built_in">solve1</span>(i);<br>        <span class="hljs-keyword">else</span> <span class="hljs-built_in">solve2</span>(i);<br>    &#125;<br>    <span class="hljs-built_in">solve</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=Q;++i) <span class="hljs-keyword">if</span>(q[i].op==<span class="hljs-number">2</span>) cout&lt;&lt;ans[i]&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="序列分块套值域分块"><a href="#序列分块套值域分块" class="headerlink" title="序列分块套值域分块"></a>序列分块套值域分块</h3><p>先来个简单问题：全局 kth。</p>
<p>权值线段树很好维护对吧，线段树上二分即可。</p>
<p>考虑值域分块怎么做。</p>
<p>事实上是类似的。枚举整块，如果超了就枚举块内。</p>
<p>复杂度 <script type="math/tex">O(n\sqrt n)</script></p>
<p>那现在加强一下：区间 kth。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P3834">【模板】可持久化线段树 2</a></p>
<p>主席树可以做，那分块呢？</p>
<p>在学值域分块前，我的第一想法是序列分块+二分。</p>
<p>然而复杂度是 <script type="math/tex">O(n\sqrt n \log n)</script></p>
<p>能不能把 <script type="math/tex">log</script> 去掉呢？</p>
<p>我们考虑序列分块套值域分块。</p>
<p>这种值域类数据结构都有非常好的性质：单调性。</p>
<p>我们先对序列分块，维护块内每个数的出现次数。</p>
<p>然后对值域分块，维护每个序列块内每个值域块中数的出现次数。</p>
<p>然后对序列块做上面两个信息的前缀和，这样就可以 <script type="math/tex">O(1)</script> 查询一段块内每个数的出现次数以及每个值域块中数的出现次数。</p>
<p>这个预处理的复杂度是 <script type="math/tex">O(n\sqrt n)</script> 的。</p>
<p>查询时，我们先把散块里的元素放到一个桶里，再把值域块中的数放到一个桶里。</p>
<p>然后跳值域块，超过 <script type="math/tex">k</script> 时就跳块内的数。</p>
<p>复杂度 <script type="math/tex">O(n\sqrt n)</script></p>
<p>代码实现里序列块和值域块共用了块长和所有编号，请分清哪个是序列块，哪个是值域块。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">2e5</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">500</span>;<br><span class="hljs-type">int</span> n,m,siz,tot;<br><span class="hljs-type">int</span> a[maxn],b[maxn];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn];<br><span class="hljs-type">int</span> cnt1[maxm][maxn],cnt2[maxm][maxm];<br><span class="hljs-type">int</span> buc1[maxn],buc2[maxm];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    siz=<span class="hljs-built_in">sqrt</span>(n);<br>    tot=n/siz;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;n) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=n;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pre</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;++j) cnt1[i][j]=cnt1[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=tot;++j) cnt2[i][j]=cnt2[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) ++cnt1[i][a[j]],++cnt2[i][bel[a[j]]];<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> k)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r],res=<span class="hljs-number">-1</span>,tmp=<span class="hljs-number">0</span>,id=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=b[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i]+cnt1[R<span class="hljs-number">-1</span>][i]-cnt1[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=b[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>	</span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i],b[i]=a[i];<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>);<br>    <span class="hljs-type">int</span> len=<span class="hljs-built_in">unique</span>(b<span class="hljs-number">+1</span>,b+n<span class="hljs-number">+1</span>)-(b<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) a[i]=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+len<span class="hljs-number">+1</span>,a[i])-b;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-built_in">pre</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,l,r,k;i&lt;=m;++i)&#123;<br>        cin&gt;&gt;l&gt;&gt;r&gt;&gt;k;<br>        cout&lt;&lt;<span class="hljs-built_in">query</span>(l,r,k)&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>那再加强一下：单点修。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2617">Dynamic Rankings</a></p>
<p>因为我们预处理的是前缀和，所以要更改 <script type="math/tex">O(\sqrt n)</script> 的块。</p>
<p>代码基本相同。</p>
<p>但如果你还把两种块的编号并用，请注意元素个数可能会 <script type="math/tex">> n</script>。</p>
<p>代码里的 <code>n=cnt</code> 就是解决这一情况的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-comment">// #define int long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">2e5</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">500</span>;<br><span class="hljs-type">int</span> n,m,siz,tot,cnt;<br><span class="hljs-type">int</span> a[maxn],b[maxn];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn];<br><span class="hljs-type">int</span> cnt1[maxm][maxn],cnt2[maxm][maxm];<br><span class="hljs-type">int</span> buc1[maxn],buc2[maxm];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">query</span>&#123;<br>    <span class="hljs-type">int</span> op;<br>    <span class="hljs-type">int</span> l,r,k;<br>    <span class="hljs-type">int</span> x,y;<br>&#125;q[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    n=cnt;<br>    siz=<span class="hljs-built_in">sqrt</span>(n);<br>    tot=n/siz;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;n) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=n;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pre</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;++j) cnt1[i][j]=cnt1[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=tot;++j) cnt2[i][j]=cnt2[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) ++cnt1[i][a[j]],++cnt2[i][bel[a[j]]];<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<br>    <span class="hljs-type">int</span> pos=bel[x];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=pos;i&lt;=tot;++i)&#123;<br>        --cnt1[i][a[x]];<br>        --cnt2[i][bel[a[x]]];<br>        ++cnt1[i][y];<br>        ++cnt2[i][bel[y]];<br>    &#125;<br>    a[x]=y;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> k)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r],res=<span class="hljs-number">-1</span>,tmp=<span class="hljs-number">0</span>,id=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=b[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) ++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i]+cnt1[R<span class="hljs-number">-1</span>][i]-cnt1[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=b[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>	</span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i],b[++cnt]=a[i];<br>    <span class="hljs-type">char</span> op;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i)&#123;<br>        cin&gt;&gt;op;<br>        <span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;Q&#x27;</span>) cin&gt;&gt;q[i].l&gt;&gt;q[i].r&gt;&gt;q[i].k,q[i].op=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">else</span> cin&gt;&gt;q[i].x&gt;&gt;q[i].y,q[i].op=<span class="hljs-number">2</span>,b[++cnt]=q[i].y;<br>    &#125;<br>    <span class="hljs-built_in">sort</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>);<br>    cnt=<span class="hljs-built_in">unique</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>)-(b<span class="hljs-number">+1</span>);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) a[i]=<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>,a[i])-b;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-built_in">pre</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i)&#123;<br>        <span class="hljs-keyword">if</span>(q[i].op==<span class="hljs-number">1</span>) cout&lt;&lt;<span class="hljs-built_in">query</span>(q[i].l,q[i].r,q[i].k)&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>        <span class="hljs-keyword">else</span> <span class="hljs-built_in">modify</span>(q[i].x,<span class="hljs-built_in">lower_bound</span>(b<span class="hljs-number">+1</span>,b+cnt<span class="hljs-number">+1</span>,q[i].y)-b);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>那再加强一下：区间修。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4119">[Ynoi2018] 未来日记</a></p>
<p>望月悲叹的最初分块。</p>
<p>每个序列块用并查集把所有值相同的缩在一起。然后维护 <code>rt[i][x]</code>，表示第 <script type="math/tex">i</script> 个块中某个值为 <script type="math/tex">x</script> 的数的位置。</p>
<p>对于整块修改，如果 <script type="math/tex">x</script> 不存在，直接无视。</p>
<p>否则，如果 <script type="math/tex">y</script> 不存在，那么就把 <script type="math/tex">x</script> 映射成 <script type="math/tex">y</script>。</p>
<p>否则暴力重构。</p>
<p>然后还要把我们维护的前缀和修改掉。</p>
<p>因为是区间修，所以我们还得再记录一下每个序列块内每个数的出现次数，用于修改后面的前缀和。</p>
<p>对于散块修改，直接暴力重构即可。</p>
<p>具体的，我们把并查集的信息全部重新维护一遍，然后再把后面块的前缀和修改一下。</p>
<p>感觉说的也不是很清楚？那放一下<a target="_blank" rel="noopener" href="https://olddrivertree.blog.uoj.ac/blog/4715">lxl的题解</a>吧。</p>
<p>实现参考了题解（我太菜了写不出来QWQ）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-comment">// #define int long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">1e5</span><span class="hljs-number">+10</span>,maxm=<span class="hljs-number">170</span>;<br><span class="hljs-type">int</span> n,m,siz,tot;<br><span class="hljs-type">int</span> a[maxn];<br><span class="hljs-type">int</span> st[maxm],ed[maxm],bel[maxn];<br><span class="hljs-type">int</span> cnt1[maxm][maxn],cnt2[maxm][maxm],cnt3[maxm][maxn];<br><span class="hljs-type">int</span> buc1[maxn],buc2[maxm];<br><span class="hljs-type">int</span> fa[maxn],rt[maxm][maxn];<br><span class="hljs-type">int</span> stk[maxn];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">if</span>(x!=fa[x]) fa[x]=<span class="hljs-built_in">find</span>(fa[x]);<span class="hljs-keyword">return</span> fa[x];&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>    siz=<span class="hljs-number">600</span>;<br>    tot=n/siz;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) st[i]=(i<span class="hljs-number">-1</span>)*siz<span class="hljs-number">+1</span>,ed[i]=i*siz;<br>    <span class="hljs-keyword">if</span>(ed[tot]&lt;n) ++tot,st[tot]=ed[tot<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,ed[tot]=n;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i) <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) bel[j]=i;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pre</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j)&#123;<br>            <span class="hljs-keyword">if</span>(!rt[i][a[j]]) rt[i][a[j]]=j; <br>            <span class="hljs-keyword">else</span> fa[j]=rt[i][a[j]];<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;++j) cnt1[i][j]=cnt1[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=tot;++j) cnt2[i][j]=cnt2[i<span class="hljs-number">-1</span>][j];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> j=st[i];j&lt;=ed[i];++j) ++cnt1[i][a[j]],++cnt2[i][bel[a[j]]],++cnt3[i][a[j]];<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> p,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<br>    <span class="hljs-type">int</span> tmp=<span class="hljs-number">0</span>,top=<span class="hljs-number">0</span>,L=st[p],R=ed[p];<br>    rt[p][x]=rt[p][y]=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L;i&lt;=R;++i)&#123;<br>        a[i]=a[<span class="hljs-built_in">find</span>(i)];<br>        <span class="hljs-keyword">if</span>(a[i]==x||a[i]==y) stk[++top]=i;<br>    &#125;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) <span class="hljs-keyword">if</span>(a[i]==x) a[i]=y,++tmp;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=top;++i) fa[stk[i]]=stk[i];<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=top;++i)&#123;<br>        <span class="hljs-keyword">if</span>(!rt[p][a[stk[i]]]) rt[p][a[stk[i]]]=stk[i];<br>        <span class="hljs-keyword">else</span> fa[stk[i]]=rt[p][a[stk[i]]];<br>    &#125;<br>    cnt3[p][x]-=tmp,cnt3[p][y]+=tmp;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=p;i&lt;=tot;++i)&#123;<br>        cnt1[i][x]-=tmp,cnt1[i][y]+=tmp;<br>        <span class="hljs-keyword">if</span>(bel[x]!=bel[y]) cnt2[i][bel[x]]-=tmp,cnt2[i][bel[y]]+=tmp;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(x==y) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r];<br>    <span class="hljs-keyword">if</span>(L==R) <span class="hljs-built_in">update</span>(L,l,r,x,y);<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">update</span>(L,l,ed[L],x,y),<span class="hljs-built_in">update</span>(R,st[R],r,x,y);<br>        <span class="hljs-type">int</span> tmp1=<span class="hljs-number">0</span>,tmp2=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=L<span class="hljs-number">+1</span>;i&lt;=R<span class="hljs-number">-1</span>;++i)&#123;<br>            <span class="hljs-keyword">if</span>(rt[i][x])&#123;<br>                <span class="hljs-keyword">if</span>(!rt[i][y]) rt[i][y]=rt[i][x],a[rt[i][x]]=y;<br>                <span class="hljs-keyword">else</span> fa[rt[i][x]]=rt[i][y];<br>                rt[i][x]=<span class="hljs-number">0</span>;<br>                tmp1=cnt3[i][x],tmp2+=tmp1;<br>                cnt3[i][y]+=tmp1,cnt3[i][x]=<span class="hljs-number">0</span>;<br>            &#125;<br>            cnt1[i][x]-=tmp2,cnt1[i][y]+=tmp2;<br>            <span class="hljs-keyword">if</span>(bel[x]!=bel[y]) cnt2[i][bel[x]]-=tmp2,cnt2[i][bel[y]]+=tmp2;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=R;i&lt;=tot;++i)&#123;<br>            cnt1[i][x]-=tmp2,cnt1[i][y]+=tmp2;<br>            <span class="hljs-keyword">if</span>(bel[x]!=bel[y]) cnt2[i][bel[x]]-=tmp2,cnt2[i][bel[y]]+=tmp2;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> k)</span></span>&#123;<br>    <span class="hljs-type">int</span> L=bel[l],R=bel[r],res=<span class="hljs-number">-1</span>,tmp=<span class="hljs-number">0</span>,id=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(L==R)&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) a[i]=a[<span class="hljs-built_in">find</span>(i)],++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) a[i]=a[<span class="hljs-built_in">find</span>(i)],++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) a[i]=a[<span class="hljs-built_in">find</span>(i)],++buc1[a[i]],++buc2[bel[a[i]]];<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=tot;++i)&#123;<br>            tmp+=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                tmp-=buc2[i]+cnt2[R<span class="hljs-number">-1</span>][i]-cnt2[L][i];<br>                id=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[id];i&lt;=ed[id];++i)&#123;<br>            tmp+=buc1[i]+cnt1[R<span class="hljs-number">-1</span>][i]-cnt1[L][i];<br>            <span class="hljs-keyword">if</span>(tmp&gt;=k)&#123;<br>                res=i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=l;i&lt;=ed[L];++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=st[R];i&lt;=r;++i) buc1[a[i]]=<span class="hljs-number">0</span>,buc2[bel[a[i]]]=<span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>	</span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i],fa[i]=i;<br>    <span class="hljs-built_in">init</span>();<br>    <span class="hljs-built_in">pre</span>();<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,op,l,r,x,y,k;i&lt;=m;++i)&#123;<br>        cin&gt;&gt;op;<br>        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) cin&gt;&gt;l&gt;&gt;r&gt;&gt;x&gt;&gt;y,<span class="hljs-built_in">modify</span>(l,r,x,y);<br>        <span class="hljs-keyword">else</span> cin&gt;&gt;l&gt;&gt;r&gt;&gt;k,cout&lt;&lt;<span class="hljs-built_in">query</span>(l,r,k)&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>事实上这东西和主席树很像，都是维护前缀信息，然后通过差分求区间信息。</p>
<p>一般来说，我们都会维护前缀序列块的某个值域块的前缀和，这样可以方便修改。</p>
<p>有时候，我们还会维护前缀序列块的前缀值域块的前缀和。</p>
<p>例如<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/AT_abc339_g">[ABC339G] Smaller Sum</a>，我们维护前缀序列块的前缀值域块的前缀和。</p>
<p>在序列上，我们把询问差分成 <script type="math/tex">[1,r]-[1,l-1]</script>，然后因为我们还维护了前缀值域块的前缀和，所以 <script type="math/tex">\le x</script> 的和也直接求出来了。</p>
<h3 id="倍增值域分块"><a href="#倍增值域分块" class="headerlink" title="倍增值域分块"></a>倍增值域分块</h3><p>倍增值域分块，就是把值域分成 <script type="math/tex">[b^k,b^{k+1})</script> 的形式，一般取 <script type="math/tex">b=2</script>。</p>
<p>通常用来解决 <script type="math/tex">a_i\ge x,a_i\leftarrow a_i-x</script> 的操作。</p>
<p>常见做法是每块建一颗线段树维护。</p>
<p>例题1：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/CF1515I">Phoenix and Diamonds</a> *3400</p>
<p>考虑倍增值域分块。</p>
<p>我们把值域按 <script type="math/tex">[2^k,2^{k+1})</script> 分块。</p>
<p>设 <script type="math/tex">c</script> 当前在的块是 <script type="math/tex">[2^k,2^{k+1})</script>，那么 <script type="math/tex">w_i</script> 有三种情况：<script type="math/tex">w_i < 2^k</script>，<script type="math/tex">w_i \in [2^k,2^{k+1})</script>，<script type="math/tex">w_i \ge 2^{k+1}</script>。</p>
<p>最后一种情况显然不需要考虑。</p>
<p>如果选了第二种情况，那么 <script type="math/tex">c</script> 就会向下掉一层。</p>
<p>如果选了第一种情况，那么也有两种情况：一直选，然后掉到下一层；或者直接选完。</p>
<p>考虑对每一块开一颗线段树维护。</p>
<p>线段树上维护 <script type="math/tex">w_i < 2^k</script> 的 <script type="math/tex">\sum w_i</script> 和 <script type="math/tex">\sum v_i</script>，以及选一个 <script type="math/tex">w_i \in [2^k,2^{k+1})</script> 所需的 <script type="math/tex">c</script> 的最小值（别忘了拿 <script type="math/tex">[2^k,2^{k+1})</script> 的条件是先把前面拿完）。</p>
<p>查询就是线段树上二分。</p>
<p>还有另一种写法，不过差不多。</p>
<p>线段树上每个节点维护所有块信息，维护的东西不变。</p>
<p>设 <script type="math/tex">sw_k=\sum_{w_i < 2^k} w_i,sv_k=\sum_{w_i < 2^k} v_i</script>，<script type="math/tex">mn</script> 为上文提到的 <script type="math/tex">c</script> 的最小值。</p>
<p>那么查询时，如果 <script type="math/tex">c\ge sw_k</script>，那么说明小物品都能拿，那么直接返回 <script type="math/tex">sw_k</script>。</p>
<p>如果 <script type="math/tex">sw_{k-1}\le c < mn_{k-1}</script>，说明比 <script type="math/tex">c</script> 所在层的下一层还要小的物品可以全拿（拿完以后可能掉下去也可能不掉下去），但是下一层的物品一个也拿不了，那么直接返回 <script type="math/tex">sw_{k-1}</script>。</p>
<p>否则向两边递归。可以证明复杂度为 <script type="math/tex">O(\log V)</script>。</p>
<p>感性理解就是每次递归都至少往下走一层，最多走 <script type="math/tex">O(\log V)</script> 层。</p>
<p>复杂度 <script type="math/tex">O(n\log n \log V)</script></p>
<p>实现时，查询里要实时维护当前在哪一层。</p>
<p>代码实现了第二种（感觉线段树上二分不太好写）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;bits/stdc++.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> re register</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> maxn=<span class="hljs-number">2e5</span><span class="hljs-number">+10</span>,maxv=<span class="hljs-number">20</span>,inf=<span class="hljs-number">2e18</span>;<br><span class="hljs-type">int</span> n,m,c,rt,segcnt,now;<br><span class="hljs-type">int</span> seq[maxn],id[maxn];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span>&#123;<br>    <span class="hljs-type">int</span> num,w,v,id;<br>&#125;a[maxn];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node1</span>&#123;<br>    <span class="hljs-type">int</span> sw,sv,tot;<br>&#125;;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tree</span>&#123;<br>    <span class="hljs-type">int</span> ls,rs;<br>    node1 s[maxv];<br>&#125;tr[maxn&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(a[x].v==a[y].v) <span class="hljs-keyword">return</span> a[x].w&lt;a[y].w;<br>    <span class="hljs-keyword">return</span> a[x].v&gt;a[y].v;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">up</span><span class="hljs-params">(<span class="hljs-type">int</span> p)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">18</span>;++i)&#123;<br>        tr[p].s[i].sw=tr[tr[p].ls].s[i].sw+tr[tr[p].rs].s[i].sw;<br>        tr[p].s[i].sv=tr[tr[p].ls].s[i].sv+tr[tr[p].rs].s[i].sv;<br>        tr[p].s[i].tot=<span class="hljs-built_in">min</span>(tr[tr[p].ls].s[i].tot,tr[tr[p].ls].s[i].sw+tr[tr[p].rs].s[i].tot);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">(<span class="hljs-type">int</span> p,<span class="hljs-type">int</span> pos)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">18</span>;++i)&#123;<br>        tr[p].s[i].sw=tr[p].s[i].sv=<span class="hljs-number">0</span>,tr[p].s[i].tot=inf;<br>        <span class="hljs-keyword">if</span>(a[pos].w&lt;(<span class="hljs-number">1</span>&lt;&lt;(i<span class="hljs-number">-1</span>))) tr[p].s[i].sw=a[pos].w*a[pos].num,tr[p].s[i].sv=a[pos].v*a[pos].num;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a[pos].w&lt;(<span class="hljs-number">1</span>&lt;&lt;i)&amp;&amp;a[pos].num) tr[p].s[i].tot=a[pos].w; <br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> &amp;p)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(!p) p=++segcnt;<br>    <span class="hljs-keyword">if</span>(l==r)&#123;<span class="hljs-built_in">init</span>(p,id[l]);<span class="hljs-keyword">return</span>;&#125;<br>    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">build</span>(l,mid,tr[p].ls),<span class="hljs-built_in">build</span>(mid<span class="hljs-number">+1</span>,r,tr[p].rs);<br>    <span class="hljs-built_in">up</span>(p);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> pos,<span class="hljs-type">int</span> p)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(l==r)&#123;<span class="hljs-built_in">init</span>(p,id[pos]);<span class="hljs-keyword">return</span>;&#125;<br>    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span>(pos&lt;=mid) <span class="hljs-built_in">update</span>(l,mid,pos,tr[p].ls);<br>    <span class="hljs-keyword">else</span> <span class="hljs-built_in">update</span>(mid<span class="hljs-number">+1</span>,r,pos,tr[p].rs);<br>    <span class="hljs-built_in">up</span>(p);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">calc</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">while</span>(now&gt;<span class="hljs-number">1</span>&amp;&amp;(<span class="hljs-number">1</span>&lt;&lt;((now<span class="hljs-number">-1</span>)<span class="hljs-number">-1</span>))&gt;c) --now;&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> p)</span></span>&#123;<br>    <span class="hljs-keyword">if</span>(l==r)&#123;<br>        <span class="hljs-type">int</span> num=<span class="hljs-built_in">min</span>(a[id[l]].num,c/a[id[l]].w);<br>        c-=num*a[id[l]].w;<span class="hljs-built_in">calc</span>();<br>        <span class="hljs-keyword">return</span> num*a[id[l]].v;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(c&gt;=tr[p].s[now].sw)&#123;<span class="hljs-type">int</span> tmp=tr[p].s[now].sv;c-=tr[p].s[now].sw,<span class="hljs-built_in">calc</span>();<span class="hljs-keyword">return</span> tmp;&#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(c&gt;=tr[p].s[now<span class="hljs-number">-1</span>].sw&amp;&amp;c&lt;tr[p].s[now<span class="hljs-number">-1</span>].tot)&#123;<span class="hljs-type">int</span> tmp=tr[p].s[now<span class="hljs-number">-1</span>].sv;c-=tr[p].s[now<span class="hljs-number">-1</span>].sw,<span class="hljs-built_in">calc</span>();<span class="hljs-keyword">return</span> tmp;&#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(l,mid,tr[p].ls)+<span class="hljs-built_in">query</span>(mid<span class="hljs-number">+1</span>,r,tr[p].rs);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span><br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.in&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,stdin);<br>    <span class="hljs-built_in">freopen</span>(<span class="hljs-string">&quot;1.out&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-number">0</span>),cin.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>),cout.<span class="hljs-built_in">tie</span>(<span class="hljs-number">0</span>);<br>    cin&gt;&gt;n&gt;&gt;m;<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) cin&gt;&gt;a[i].num&gt;&gt;a[i].w&gt;&gt;a[i].v,id[i]=i;<br>    <span class="hljs-built_in">sort</span>(id<span class="hljs-number">+1</span>,id+n<span class="hljs-number">+1</span>,cmp);<br>    <span class="hljs-keyword">for</span>(re <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) seq[id[i]]=i;<br>    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,n,rt);<br>    <span class="hljs-keyword">while</span>(m--)&#123;<br>        <span class="hljs-type">int</span> op,num,pos;<br>        cin&gt;&gt;op;<br>        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>)&#123;<br>            cin&gt;&gt;c;now=<span class="hljs-number">18</span>;<span class="hljs-built_in">calc</span>();<br>            cout&lt;&lt;<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,n,<span class="hljs-number">1</span>)&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            cin&gt;&gt;num&gt;&gt;pos;<br>            <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) a[pos].num+=num;<br>            <span class="hljs-keyword">else</span> a[pos].num-=num;<br>            <span class="hljs-built_in">update</span>(<span class="hljs-number">1</span>,n,seq[pos],<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>例题2：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P7447">[Ynoi2007] rgxsxrs</a></p>
<p>摆</p>
<p>例题3：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P9069">[Ynoi Easy Round 2022] 堕天作战 TEST_98</a></p>
<p>摆</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/10/08/2024-10-8/">← 下一篇 2024.10.8</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/10/04/bitset%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">bitset学习笔记 上一篇 →</a></div></div></div><div id="comments"><div id="gitalk"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">xtzqhy</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97"><span class="toc-number">1.</span> <span class="toc-text">什么是值域分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97"><span class="toc-number">2.</span> <span class="toc-text">两种常用的值域分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97%E9%85%8D%E5%90%88%E8%8E%AB%E9%98%9F"><span class="toc-number">4.</span> <span class="toc-text">值域分块配合莫队</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97%E9%85%8D%E5%90%88%E6%A0%B9%E5%8F%B7%E5%88%86%E6%B2%BB"><span class="toc-number">5.</span> <span class="toc-text">值域分块配合根号分治</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%88%86%E5%9D%97%E5%A5%97%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97"><span class="toc-number">6.</span> <span class="toc-text">序列分块套值域分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%8D%E5%A2%9E%E5%80%BC%E5%9F%9F%E5%88%86%E5%9D%97"><span class="toc-number">7.</span> <span class="toc-text">倍增值域分块</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>